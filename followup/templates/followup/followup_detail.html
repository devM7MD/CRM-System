{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Follow-up Details" %}{% endblock %}

{% block header %}{% trans "Follow-up Details" %}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-4 flex justify-between items-center border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800">{% trans "Follow-up for Order" %}: {{ followup.order.order_code }}</h3>
            <div class="flex space-x-2">
                <a href="{% url 'followup:record_feedback' followup.order.id %}" class="text-sm px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 inline-flex items-center">
                    <i class="fas fa-clipboard-check mr-1"></i> {% trans "Record Feedback" %}
                </a>
                <a href="{% url 'followup:orders' %}" class="text-sm px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 inline-flex items-center">
                    <i class="fas fa-arrow-left mr-1"></i> {% trans "Back to List" %}
                </a>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Order Information -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Order Information" %}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Order ID" %}</p>
                        <p class="font-medium">{{ followup.order.order_code }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Customer" %}</p>
                        <p class="font-medium">
                            {% if followup.order.customer %}
                                {{ followup.order.customer.get_full_name|default:followup.order.customer.email }}
                            {% elif followup.order.customer_name %}
                                {{ followup.order.customer_name }}
                            {% else %}
                                {% trans "Unknown" %}
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Order Date" %}</p>
                        <p class="font-medium">{{ followup.order.date|date:"M d, Y" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Order Status" %}</p>
                        <p class="font-medium">{{ followup.order.get_status_display }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Contact Phone" %}</p>
                        <p class="font-medium">
                            {% if followup.order.customer.phone_number %}
                                {{ followup.order.customer.phone_number }}
                            {% elif followup.order.customer_phone %}
                                {{ followup.order.customer_phone }}
                            {% else %}
                                {% trans "N/A" %}
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Contact Email" %}</p>
                        <p class="font-medium">
                            {% if followup.order.customer.email %}
                                {{ followup.order.customer.email }}
                            {% elif followup.order.customer_email %}
                                {{ followup.order.customer_email }}
                            {% else %}
                                {% trans "N/A" %}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Follow-up Status -->
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Follow-up Status" %}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Current Status" %}</p>
                        <p class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if followup.status == 'pending' %}bg-yellow-100 text-yellow-800{% endif %}
                        {% if followup.status == 'in_progress' %}bg-blue-100 text-blue-800{% endif %}
                        {% if followup.status == 'completed' %}bg-green-100 text-green-800{% endif %}
                        {% if followup.status == 'cancelled' %}bg-red-100 text-red-800{% endif %}">
                            {{ followup.get_status_display }}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Scheduled For" %}</p>
                        <p class="font-medium">{{ followup.scheduled_for|date:"M d, Y"|default:"Not scheduled" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Assigned To" %}</p>
                        <p class="font-medium">{{ followup.agent.get_full_name|default:followup.agent.username }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Created On" %}</p>
                        <p class="font-medium">{{ followup.created_at|date:"M d, Y" }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Last Updated" %}</p>
                        <p class="font-medium">{{ followup.updated_at|date:"M d, Y" }}</p>
                    </div>
                    {% if followup.completed_at %}
                    <div>
                        <p class="text-sm text-gray-500">{% trans "Completed On" %}</p>
                        <p class="font-medium">{{ followup.completed_at|date:"M d, Y" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Follow-up Notes -->
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Follow-up Notes" %}</h4>
                <div class="bg-white border border-gray-200 rounded-md p-4">
                    {% if followup.feedback %}
                        <p class="text-sm text-gray-800 whitespace-pre-line">{{ followup.feedback }}</p>
                    {% else %}
                        <p class="text-sm text-gray-500 italic">{% trans "No notes have been added yet." %}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Customer Feedback -->
            {% if feedback %}
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Customer Feedback" %}</h4>
                <div class="bg-white border border-gray-200 rounded-md p-4">
                    <div class="flex items-center mb-3">
                        <div class="text-sm text-gray-500 mr-3">{% trans "Rating:" %}</div>
                        <div class="flex items-center">
                            {% for i in "12345" %}
                                {% if i|add:"0" <= feedback.rating %}
                                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% else %}
                                    <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                            <span class="text-sm font-medium text-gray-700 ml-1">{{ feedback.rating }}/5</span>
                        </div>
                    </div>
                    {% if feedback.comments %}
                        <div class="text-sm text-gray-500 mb-1">{% trans "Comments:" %}</div>
                        <p class="text-sm text-gray-800 whitespace-pre-line">{{ feedback.comments }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if "Seller requested status change" in followup.feedback %}
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Seller Status Change Request" %}</h4>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">{% trans "Pending Status Change Request" %}</h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                {% if 'from' in followup.feedback and 'to' in followup.feedback %}
                                    {% with feedback_lines=followup.feedback.split %}
                                        {% for line in feedback_lines %}
                                            {% if "Seller requested status change" in line %}
                                                <p class="whitespace-pre-line">{{ line }}</p>
                                                {% if followup.status != 'completed' and followup.status != 'cancelled' %}
                                                <div class="mt-3 flex space-x-3">
                                                    <a href="{% url 'orders:update_order_status' followup.order.id %}?approve=true" 
                                                       class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                        {% trans "Approve Change" %}
                                                    </a>
                                                    <a href="{% url 'orders:update_order_status' followup.order.id %}?reject=true" 
                                                       class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                                        {% trans "Reject Change" %}
                                                    </a>
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Update Status Form -->
            {% if followup.status != 'completed' and followup.status != 'cancelled' %}
            <div class="mb-6">
                <h4 class="text-md font-medium text-gray-800 mb-3">{% trans "Update Status" %}</h4>
                <form method="post" class="bg-white border border-gray-200 rounded-md p-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Status" %}</label>
                            <select id="status" name="status" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50">
                                <option value="pending" {% if followup.status == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                                <option value="in_progress" {% if followup.status == 'in_progress' %}selected{% endif %}>{% trans "In Progress" %}</option>
                                <option value="completed" {% if followup.status == 'completed' %}selected{% endif %}>{% trans "Completed" %}</option>
                                <option value="cancelled" {% if followup.status == 'cancelled' %}selected{% endif %}>{% trans "Cancelled" %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="feedback" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Notes" %}</label>
                        <textarea id="feedback" name="feedback" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50">{{ followup.feedback }}</textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            {% trans "Update Follow-up" %}
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %} 