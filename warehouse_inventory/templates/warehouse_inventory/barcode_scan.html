{% extends 'warehouse_inventory/base.html' %}
{% load i18n %}
{% load static %}

{% block page_title %}{% trans "Barcode Scanner" %}{% endblock %}

{% block inventory_content %}
<div class="max-w-4xl mx-auto">
    <!-- Scanner Interface -->
    <div class="bg-white shadow sm:rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                {% trans "Scan Barcode" %}
            </h3>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <!-- Warehouse Selection -->
                <div>
                    <label for="warehouse_id" class="block text-sm font-medium text-gray-700">
                        {% trans "Warehouse" %}
                    </label>
                    <select id="warehouse_id" name="warehouse_id" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Action Selection -->
                <div>
                    <label for="action" class="block text-sm font-medium text-gray-700">
                        {% trans "Action" %}
                    </label>
                    <select id="action" name="action" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="lookup">{% trans "Lookup" %}</option>
                        <option value="add_stock">{% trans "Add Stock" %}</option>
                        <option value="update_quantity">{% trans "Update Quantity" %}</option>
                    </select>
                </div>

                <!-- Quantity Input (hidden by default) -->
                <div id="quantity_container" class="hidden">
                    <label for="quantity" class="block text-sm font-medium text-gray-700">
                        {% trans "Quantity" %}
                    </label>
                    <input type="number" name="quantity" id="quantity" min="1"
                           class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                           placeholder="0">
                </div>
            </div>

            <!-- Barcode Input -->
            <div class="mt-6">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input type="text" id="barcode" name="barcode" 
                               class="focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                               placeholder="{% trans 'Scan or enter barcode...' %}"
                               autofocus>
                    </div>
                    <button type="button" id="scan_button"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-barcode mr-2"></i>
                        {% trans "Scan" %}
                    </button>
                </div>
                <p class="mt-2 text-sm text-gray-500">
                    {% trans "Press Enter or click Scan after entering the barcode" %}
                </p>
            </div>
        </div>
    </div>

    <!-- Results Display -->
    <div id="results" class="hidden bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                {% trans "Scan Results" %}
            </h3>
            
            <div id="result_content">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error_message" class="hidden rounded-md bg-red-50 p-4 mt-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                    {% trans "Error" %}
                </h3>
                <div class="mt-2 text-sm text-red-700">
                    <p id="error_text"></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcode');
    const scanButton = document.getElementById('scan_button');
    const actionSelect = document.getElementById('action');
    const quantityContainer = document.getElementById('quantity_container');
    const quantityInput = document.getElementById('quantity');
    const resultsDiv = document.getElementById('results');
    const resultContent = document.getElementById('result_content');
    const errorMessage = document.getElementById('error_message');
    const errorText = document.getElementById('error_text');
    
    // Show/hide quantity input based on action
    actionSelect.addEventListener('change', function() {
        if (this.value === 'add_stock' || this.value === 'update_quantity') {
            quantityContainer.classList.remove('hidden');
            quantityInput.required = true;
        } else {
            quantityContainer.classList.add('hidden');
            quantityInput.required = false;
        }
    });
    
    // Handle barcode scanning
    function handleScan() {
        const barcode = barcodeInput.value.trim();
        if (!barcode) return;
        
        const warehouseId = document.getElementById('warehouse_id').value;
        const action = actionSelect.value;
        const quantity = quantityInput.value;
        
        // Hide previous results/errors
        resultsDiv.classList.add('hidden');
        errorMessage.classList.add('hidden');
        
        // Prepare request data
        const data = new FormData();
        data.append('barcode', barcode);
        data.append('warehouse_id', warehouseId);
        data.append('action', action);
        if (quantity) data.append('quantity', quantity);
        
        // Send request
        fetch('{% url "warehouse_inventory:barcode_scan" %}', {
            method: 'POST',
            body: data,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultsDiv.classList.remove('hidden');
                
                if (action === 'lookup') {
                    // Display product information
                    resultContent.innerHTML = `
                        <dl class="grid grid-cols-1 gap-5 sm:grid-cols-2">
                            <div class="px-4 py-5 bg-gray-50 sm:p-6">
                                <dt class="text-sm font-medium text-gray-500">
                                    {% trans "Product" %}
                                </dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    ${data.product.name}
                                </dd>
                            </div>
                            <div class="px-4 py-5 bg-gray-50 sm:p-6">
                                <dt class="text-sm font-medium text-gray-500">
                                    {% trans "Code" %}
                                </dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    ${data.product.code}
                                </dd>
                            </div>
                            <div class="px-4 py-5 bg-gray-50 sm:p-6">
                                <dt class="text-sm font-medium text-gray-500">
                                    {% trans "Warehouse" %}
                                </dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    ${data.product.warehouse}
                                </dd>
                            </div>
                            <div class="px-4 py-5 bg-gray-50 sm:p-6">
                                <dt class="text-sm font-medium text-gray-500">
                                    {% trans "Status" %}
                                </dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    ${data.product.status}
                                </dd>
                            </div>
                        </dl>
                    `;
                } else {
                    // Display success message for stock updates
                    resultContent.innerHTML = `
                        <div class="rounded-md bg-green-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-check-circle text-green-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-green-800">
                                        ${data.message}
                                    </p>
                                    <p class="mt-2 text-sm text-green-700">
                                        {% trans "New quantity" %}: ${data.new_quantity}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Clear inputs
                barcodeInput.value = '';
                if (quantity) quantityInput.value = '';
                barcodeInput.focus();
                
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            errorMessage.classList.remove('hidden');
            errorText.textContent = error.message || '{% trans "An error occurred while processing the barcode." %}';
        });
    }
    
    // Event listeners
    barcodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleScan();
        }
    });
    
    scanButton.addEventListener('click', handleScan);
    
    // Focus barcode input on load
    barcodeInput.focus();
});
</script>
{% endblock %} 