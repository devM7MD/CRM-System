{% extends 'warehouse_inventory/base.html' %}
{% load i18n %}
{% load static %}

{% block page_title %}{% trans "Record Inventory Movement" %} - {{ warehouse.name }}{% endblock %}

{% block inventory_content %}
<div class="max-w-4xl mx-auto">
    <form method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- Product Selection -->
        <div>
            <label for="product_id" class="block text-sm font-medium text-gray-700">{% trans "Product" %}</label>
            <select id="product_id" name="product_id" required
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">{% trans "Select a product" %}</option>
                {% for item in inventory_items %}
                <option value="{{ item.product.id }}" {% if request.GET.product == item.product.id|stringformat:"s" %}selected{% endif %}>
                    {{ item.product.name_en }} ({{ item.quantity }} {% trans "in stock" %})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Movement Type -->
        <div>
            <label for="movement_type" class="block text-sm font-medium text-gray-700">{% trans "Movement Type" %}</label>
            <select id="movement_type" name="movement_type" required
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                {% for type_code, type_name in movement_types %}
                <option value="{{ type_code }}">{{ type_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Quantity -->
        <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700">{% trans "Quantity" %}</label>
            <div class="mt-1 relative rounded-md shadow-sm">
                <input type="number" name="quantity" id="quantity" required min="1"
                       class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-4 pr-12 sm:text-sm border-gray-300 rounded-md"
                       placeholder="0">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm">{% trans "units" %}</span>
                </div>
            </div>
        </div>
        
        <!-- Destination Warehouse (for transfers) -->
        <div id="destination_warehouse_container" class="hidden">
            <label for="destination_warehouse" class="block text-sm font-medium text-gray-700">{% trans "Destination Warehouse" %}</label>
            <select id="destination_warehouse" name="destination_warehouse"
                    class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">{% trans "Select destination warehouse" %}</option>
                {% for other_warehouse in other_warehouses %}
                <option value="{{ other_warehouse.id }}">{{ other_warehouse.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Reason -->
        <div>
            <label for="reason" class="block text-sm font-medium text-gray-700">{% trans "Reason" %}</label>
            <input type="text" name="reason" id="reason"
                   class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                   placeholder="{% trans 'Brief reason for this movement' %}">
        </div>
        
        <!-- Notes -->
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700">{% trans "Notes" %}</label>
            <div class="mt-1">
                <textarea id="notes" name="notes" rows="3"
                          class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md"
                          placeholder="{% trans 'Additional details about this movement...' %}"></textarea>
            </div>
        </div>
        
        <!-- Submit -->
        <div class="flex justify-end space-x-3">
            <a href="{% url 'warehouse_inventory:warehouse_inventory' warehouse.id %}"
               class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                {% trans "Cancel" %}
            </a>
            <button type="submit"
                    class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                {% trans "Record Movement" %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const movementTypeSelect = document.getElementById('movement_type');
    const destinationWarehouseContainer = document.getElementById('destination_warehouse_container');
    const destinationWarehouseSelect = document.getElementById('destination_warehouse');
    const productSelect = document.getElementById('product_id');
    const quantityInput = document.getElementById('quantity');
    
    // Show/hide destination warehouse based on movement type
    movementTypeSelect.addEventListener('change', function() {
        if (this.value === 'transfer') {
            destinationWarehouseContainer.classList.remove('hidden');
            destinationWarehouseSelect.required = true;
        } else {
            destinationWarehouseContainer.classList.add('hidden');
            destinationWarehouseSelect.required = false;
        }
    });
    
    // Update quantity max based on selected product (for outgoing movements)
    productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const stockMatch = selectedOption.text.match(/\((\d+)/);
            if (stockMatch) {
                const currentStock = parseInt(stockMatch[1]);
                if (movementTypeSelect.value === 'out' || movementTypeSelect.value === 'transfer') {
                    quantityInput.max = currentStock;
                } else {
                    quantityInput.removeAttribute('max');
                }
            }
        }
    });
    
    // Update quantity validation when movement type changes
    movementTypeSelect.addEventListener('change', function() {
        const selectedProduct = productSelect.options[productSelect.selectedIndex];
        if (selectedProduct.value) {
            const stockMatch = selectedProduct.text.match(/\((\d+)/);
            if (stockMatch) {
                const currentStock = parseInt(stockMatch[1]);
                if (this.value === 'out' || this.value === 'transfer') {
                    quantityInput.max = currentStock;
                } else {
                    quantityInput.removeAttribute('max');
                }
            }
        }
    });
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (movementTypeSelect.value === 'transfer' && !destinationWarehouseSelect.value) {
            e.preventDefault();
            alert('{% trans "Please select a destination warehouse for transfer." %}');
            return;
        }
        
        const quantity = parseInt(quantityInput.value);
        if (isNaN(quantity) || quantity < 1) {
            e.preventDefault();
            alert('{% trans "Please enter a valid quantity (minimum 1)." %}');
            return;
        }
        
        if ((movementTypeSelect.value === 'out' || movementTypeSelect.value === 'transfer') && 
            quantity > parseInt(quantityInput.max)) {
            e.preventDefault();
            alert('{% trans "Quantity exceeds available stock." %}');
            return;
        }
    });
});
</script>
{% endblock %} 