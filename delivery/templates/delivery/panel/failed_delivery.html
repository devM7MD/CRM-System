{% extends "delivery_panel_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Failed Delivery" %}{% endblock %}

{% block header_title %}{% trans "Failed Delivery" %}{% endblock %}

{% block content %}
<div class="panel-card">
    <div class="panel-card-header">
        <h2 class="panel-card-title text-danger">
            <i class="bi bi-x-circle"></i> {% trans "Report Failed Delivery" %}
        </h2>
    </div>
    
    <div class="order-summary mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="fw-bold">{{ delivery.order.order_code }}</span>
            <span class="status-badge status-{{ delivery.status }}">
                {{ delivery.get_status_display }}
            </span>
        </div>
        
        <div class="d-flex align-items-center mb-2">
            <i class="bi bi-person-fill me-2"></i>
            <span>{{ delivery.order.customer_name }}</span>
            {% if delivery.order.customer_phone %}
                <a href="tel:{{ delivery.order.customer_phone }}" class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="bi bi-telephone"></i>
                </a>
            {% endif %}
        </div>
        
        <div class="d-flex align-items-start mb-2">
            <i class="bi bi-geo-alt-fill me-2 mt-1"></i>
            <span>{{ delivery.order.shipping_address }}</span>
        </div>
    </div>
    
    <form method="post" action="{% url 'delivery:panel_failed_delivery' order_id=delivery.order.id %}">
        {% csrf_token %}
        
        <div class="form-group mb-4">
            <label for="failure_reason" class="form-label">{% trans "Reason for Failed Delivery" %}:</label>
            <select class="form-select" id="failure_reason" name="failure_reason" required>
                <option value="">{% trans "Select a reason" %}</option>
                <option value="customer_not_available">{% trans "Customer not available" %}</option>
                <option value="wrong_address">{% trans "Wrong or incomplete address" %}</option>
                <option value="customer_refused">{% trans "Customer refused delivery" %}</option>
                <option value="payment_issue">{% trans "Payment issue" %}</option>
                <option value="weather_conditions">{% trans "Bad weather conditions" %}</option>
                <option value="delivery_damage">{% trans "Package damaged during transit" %}</option>
                <option value="security_issue">{% trans "Security issue at location" %}</option>
                <option value="time_constraint">{% trans "Time constraint/Late hour" %}</option>
                <option value="other">{% trans "Other reason" %}</option>
            </select>
        </div>
        
        <div class="form-group mb-4">
            <label for="detailed_notes" class="form-label">{% trans "Detailed Explanation" %}:</label>
            <textarea class="form-control" id="detailed_notes" name="detailed_notes" rows="4" required placeholder="{% trans 'Please provide detailed information about the delivery attempt and why it failed' %}"></textarea>
        </div>
        
        <div class="form-group mb-4">
            <label for="calls_made" class="form-label">{% trans "Call Attempts" %}:</label>
            <select class="form-select" id="calls_made" name="calls_made">
                <option value="0">{% trans "No calls made" %}</option>
                <option value="1">{% trans "1 call attempt" %}</option>
                <option value="2">{% trans "2 call attempts" %}</option>
                <option value="3">{% trans "3 or more call attempts" %}</option>
            </select>
        </div>
        
        <div class="form-group mb-4">
            <label class="form-label">{% trans "Reschedule Options" %}:</label>
            
            <div class="reschedule-options">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="reschedule_option" id="retry_today" value="retry_today">
                    <label class="form-check-label" for="retry_today">
                        {% trans "Retry later today" %}
                    </label>
                </div>
                
                <div class="retry-time-container mb-3" style="display: none;">
                    <label for="reschedule_time" class="form-label">{% trans "Preferred time" %}:</label>
                    <input type="time" class="form-control" id="reschedule_time" name="reschedule_time">
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="reschedule_option" id="tomorrow" value="tomorrow">
                    <label class="form-check-label" for="tomorrow">
                        {% trans "Attempt delivery tomorrow" %}
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="reschedule_option" id="contact_customer" value="contact_customer">
                    <label class="form-check-label" for="contact_customer">
                        {% trans "Call center should contact customer to reschedule" %}
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="reschedule_option" id="return_to_warehouse" value="return_to_warehouse" checked>
                    <label class="form-check-label" for="return_to_warehouse">
                        {% trans "Return to warehouse" %}
                    </label>
                </div>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <a href="{% url 'delivery:panel_order_detail' order_id=delivery.order.id %}" class="btn btn-outline-secondary flex-grow-1">
                {% trans "Cancel" %}
            </a>
            <button type="submit" class="btn btn-danger flex-grow-1">
                <i class="bi bi-x-circle"></i> {% trans "Report Failed Delivery" %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Reschedule options handling
        const retryTodayRadio = document.getElementById('retry_today');
        const retryTimeContainer = document.querySelector('.retry-time-container');
        const rescheduleTimeInput = document.getElementById('reschedule_time');
        
        if (retryTodayRadio && retryTimeContainer) {
            // Set current time + 2 hours as default
            const now = new Date();
            now.setHours(now.getHours() + 2);
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            rescheduleTimeInput.value = `${hours}:${minutes}`;
            
            // Show/hide retry time input
            document.querySelectorAll('input[name="reschedule_option"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.id === 'retry_today') {
                        retryTimeContainer.style.display = 'block';
                    } else {
                        retryTimeContainer.style.display = 'none';
                    }
                });
            });
        }
        
        // Failure reason validation
        const form = document.querySelector('form');
        const failureReasonSelect = document.getElementById('failure_reason');
        const detailedNotesTextarea = document.getElementById('detailed_notes');
        
        if (form && failureReasonSelect && detailedNotesTextarea) {
            form.addEventListener('submit', function(event) {
                if (failureReasonSelect.value === '') {
                    event.preventDefault();
                    alert("{% trans 'Please select a failure reason' %}");
                    failureReasonSelect.focus();
                    return false;
                }
                
                if (detailedNotesTextarea.value.trim().length < 10) {
                    event.preventDefault();
                    alert("{% trans 'Please provide more detailed notes about the failed delivery' %}");
                    detailedNotesTextarea.focus();
                    return false;
                }
                
                return true;
            });
        }
    });
</script>
{% endblock %} 