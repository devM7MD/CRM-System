{% extends "delivery_panel_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Settings" %}{% endblock %}

{% block header_title %}{% trans "Settings" %}{% endblock %}

{% block content %}
<div class="panel-card">
    <div class="panel-card-header">
        <h2 class="panel-card-title">{% trans "Profile Settings" %}</h2>
    </div>
    
    <div class="profile-section text-center mb-4">
        <div class="profile-image-container mb-3">
            {% if user.profile_image and user.profile_image.name %}
                <img src="{{ user.profile_image.url }}" alt="{{ user.full_name }}" class="profile-image rounded-circle img-thumbnail" style="width: 120px; height: 120px; object-fit: cover;">
            {% else %}
                <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}" alt="{{ user.full_name }}" class="profile-image rounded-circle img-thumbnail" style="width: 120px; height: 120px; object-fit: cover;">
            {% endif %}
        </div>
        
        <h4 class="profile-name">{{ user.full_name }}</h4>
        <p class="profile-role text-muted">
            <span class="badge bg-primary">{% trans "Delivery Agent" %}</span>
        </p>
    </div>
    
    <form method="post" action="{% url 'delivery:panel_settings' %}" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group mb-4">
            <label for="profile_image" class="form-label">{% trans "Profile Image" %}:</label>
            <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
            <div class="form-text">{% trans "Upload a profile photo (max 2MB)" %}</div>
        </div>
        
        <div class="form-group mb-4">
            <label for="full_name" class="form-label">{% trans "Full Name" %}:</label>
            <input type="text" class="form-control" id="full_name" name="full_name" value="{{ user.full_name }}" required>
        </div>
        
        <div class="form-group mb-4">
            <label for="email" class="form-label">{% trans "Email" %}:</label>
            <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
        </div>
        
        <div class="form-group mb-4">
            <label for="phone" class="form-label">{% trans "Phone Number" %}:</label>
            <input type="tel" class="form-control" id="phone" name="phone" value="{{ user.phone_number }}" required>
        </div>
        
        <h5 class="border-bottom pb-2 mb-3 mt-5">{% trans "Vehicle Information" %}</h5>
        
        <div class="form-group mb-4">
            <label for="vehicle_type" class="form-label">{% trans "Vehicle Type" %}:</label>
            <select class="form-select" id="vehicle_type" name="vehicle_type">
                <option value="">{% trans "Select Vehicle Type" %}</option>
                <option value="car" {% if courier.vehicle_type == 'car' %}selected{% endif %}>{% trans "Car" %}</option>
                <option value="motorcycle" {% if courier.vehicle_type == 'motorcycle' %}selected{% endif %}>{% trans "Motorcycle" %}</option>
                <option value="bicycle" {% if courier.vehicle_type == 'bicycle' %}selected{% endif %}>{% trans "Bicycle" %}</option>
                <option value="truck" {% if courier.vehicle_type == 'truck' %}selected{% endif %}>{% trans "Truck" %}</option>
                <option value="van" {% if courier.vehicle_type == 'van' %}selected{% endif %}>{% trans "Van" %}</option>
            </select>
        </div>
        
        <div class="form-group mb-4">
            <label for="license_plate" class="form-label">{% trans "License Plate" %}:</label>
            <input type="text" class="form-control" id="license_plate" name="license_plate" value="{{ courier.license_plate }}">
        </div>
        
        <h5 class="border-bottom pb-2 mb-3 mt-5">{% trans "App Settings" %}</h5>
        
        <div class="form-group mb-4">
            <label class="form-label">{% trans "Notifications" %}:</label>
            
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="notify_new_order" name="notify_new_order" checked>
                <label class="form-check-label" for="notify_new_order">
                    {% trans "New order assignments" %}
                </label>
            </div>
            
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="notify_customer_message" name="notify_customer_message" checked>
                <label class="form-check-label" for="notify_customer_message">
                    {% trans "Customer messages" %}
                </label>
            </div>
            
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="notify_route_update" name="notify_route_update" checked>
                <label class="form-check-label" for="notify_route_update">
                    {% trans "Route updates" %}
                </label>
            </div>
        </div>
        
        <div class="form-group mb-4">
            <label class="form-label">{% trans "Location Tracking" %}:</label>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="location_tracking" id="location_always" value="always" checked>
                <label class="form-check-label" for="location_always">
                    {% trans "Always track my location while on duty" %}
                </label>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="location_tracking" id="location_delivery" value="delivery_only">
                <label class="form-check-label" for="location_delivery">
                    {% trans "Only track during active deliveries" %}
                </label>
            </div>
            
            <div class="form-text">
                {% trans "Location tracking helps optimize routes and provide accurate ETAs to customers." %}
            </div>
        </div>
        
        <div class="d-grid gap-2 mt-5">
            <button type="submit" class="btn btn-primary">
                {% trans "Save Settings" %}
            </button>
            
            <a href="{% url 'delivery:panel_dashboard' %}" class="btn btn-outline-secondary">
                {% trans "Cancel" %}
            </a>
        </div>
    </form>
</div>

<div class="panel-card mt-3">
    <div class="panel-card-header">
        <h2 class="panel-card-title text-danger">{% trans "Account Actions" %}</h2>
    </div>
    
    <div class="account-actions">
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                <i class="bi bi-key"></i> {% trans "Change Password" %}
            </button>
            
            <a href="{% url 'delivery:panel_logout' %}" class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right"></i> {% trans "Logout" %}
            </a>
        </div>
    </div>
</div>

<div class="panel-card mt-3 mb-5">
    <div class="panel-card-header">
        <h2 class="panel-card-title">{% trans "Support" %}</h2>
    </div>
    
    <div class="support-info">
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-telephone-fill me-3 fs-4 text-primary"></i>
            <div>
                <h5 class="mb-0">{% trans "Support Hotline" %}</h5>
                <p class="mb-0"><a href="tel:+97112345678">+971 12 345 678</a></p>
            </div>
        </div>
        
        <div class="d-flex align-items-center mb-3">
            <i class="bi bi-envelope-fill me-3 fs-4 text-primary"></i>
            <div>
                <h5 class="mb-0">{% trans "Email Support" %}</h5>
                <p class="mb-0"><a href="mailto:support@example.com">support@example.com</a></p>
            </div>
        </div>
        
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-3 fs-4 text-primary"></i>
            <div>
                <h5 class="mb-0">{% trans "App Version" %}</h5>
                <p class="mb-0">v1.0.0</p>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changePasswordModalLabel">{% trans "Change Password" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group mb-3">
                        <label for="current_password" class="form-label">{% trans "Current Password" %}:</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="new_password" class="form-label">{% trans "New Password" %}:</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="confirm_password" class="form-label">{% trans "Confirm New Password" %}:</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="changePasswordBtn">{% trans "Change Password" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Preview profile image before upload
        const profileImageInput = document.getElementById('profile_image');
        const profileImage = document.querySelector('.profile-image');
        const profileImagePlaceholder = document.querySelector('.profile-image-placeholder');
        
        if (profileImageInput) {
            profileImageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        if (profileImage) {
                            profileImage.src = e.target.result;
                        } else if (profileImagePlaceholder) {
                            // Create an image element to replace the placeholder
                            const newImg = document.createElement('img');
                            newImg.src = e.target.result;
                            newImg.classList.add('profile-image', 'rounded-circle', 'img-thumbnail');
                            newImg.style.width = '120px';
                            newImg.style.height = '120px';
                            newImg.style.objectFit = 'cover';
                            
                            profileImagePlaceholder.parentNode.replaceChild(newImg, profileImagePlaceholder);
                        }
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }
        
        // Change password form validation
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const changePasswordForm = document.getElementById('changePasswordForm');
        
        if (changePasswordBtn && changePasswordForm) {
            changePasswordBtn.addEventListener('click', function() {
                const currentPassword = document.getElementById('current_password').value;
                const newPassword = document.getElementById('new_password').value;
                const confirmPassword = document.getElementById('confirm_password').value;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert("{% trans 'Please fill all password fields' %}");
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert("{% trans 'New passwords do not match' %}");
                    return;
                }
                
                if (newPassword.length < 8) {
                    alert("{% trans 'Password must be at least 8 characters long' %}");
                    return;
                }
                
                // This would typically be an AJAX call to change the password
                alert("{% trans 'Password change feature will be implemented in a future update' %}");
                $('#changePasswordModal').modal('hide');
            });
        }
    });
</script>
{% endblock %} 