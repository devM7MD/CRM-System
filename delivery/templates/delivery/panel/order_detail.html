{% extends "delivery_panel_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Order Details" %}{% endblock %}

{% block header_title %}{% trans "Order Details" %}{% endblock %}

{% block content %}
<div class="panel-card">
    <div class="panel-card-header d-flex justify-content-between align-items-center">
        <h2 class="panel-card-title">{{ delivery.order.order_code }}</h2>
        <span class="status-badge status-{{ delivery.status }}">
            {{ delivery.get_status_display }}
        </span>
    </div>
    
    <div class="order-timeline mb-4">
        <div class="d-flex justify-content-between">
            <div class="timeline-point {% if delivery.assigned_at %}active{% endif %}">
                <div class="timeline-icon">
                    <i class="bi bi-box"></i>
                </div>
                <div class="timeline-label">{% trans "Assigned" %}</div>
                <div class="timeline-time">
                    {% if delivery.assigned_at %}
                        {{ delivery.assigned_at|date:"M d, H:i" }}
                    {% endif %}
                </div>
            </div>
            
            <div class="timeline-point {% if delivery.picked_up_at %}active{% endif %}">
                <div class="timeline-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="timeline-label">{% trans "Picked Up" %}</div>
                <div class="timeline-time">
                    {% if delivery.picked_up_at %}
                        {{ delivery.picked_up_at|date:"M d, H:i" }}
                    {% endif %}
                </div>
            </div>
            
            <div class="timeline-point {% if delivery.status == 'in_transit' or delivery.status == 'delivered' or delivery.status == 'failed' %}active{% endif %}">
                <div class="timeline-icon">
                    <i class="bi bi-truck"></i>
                </div>
                <div class="timeline-label">{% trans "In Transit" %}</div>
            </div>
            
            <div class="timeline-point {% if delivery.status == 'delivered' %}active{% endif %}">
                <div class="timeline-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="timeline-label">{% trans "Delivered" %}</div>
                <div class="timeline-time">
                    {% if delivery.delivered_at %}
                        {{ delivery.delivered_at|date:"M d, H:i" }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="order-info">
        <h5 class="border-bottom pb-2 mb-3">{% trans "Customer Information" %}</h5>
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "Name" %}:</strong>
            </div>
            <div class="col-sm-8">
                {{ delivery.order.customer_name }}
            </div>
        </div>
        
        {% if delivery.order.customer_phone %}
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "Phone" %}:</strong>
            </div>
            <div class="col-sm-8">
                {{ delivery.order.customer_phone }}
                <a href="tel:{{ delivery.order.customer_phone }}" class="btn btn-sm btn-outline-primary ms-2">
                    <i class="bi bi-telephone"></i>
                </a>
                <button class="btn btn-sm btn-outline-secondary ms-1" data-bs-toggle="modal" data-bs-target="#smsModal">
                    <i class="bi bi-chat"></i>
                </button>
            </div>
        </div>
        {% endif %}
        
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "Address" %}:</strong>
            </div>
            <div class="col-sm-8">
                {{ delivery.order.shipping_address }}
                <a href="https://maps.google.com/?q={{ delivery.order.shipping_address|urlencode }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                    <i class="bi bi-geo-alt"></i>
                </a>
            </div>
        </div>
        
        <h5 class="border-bottom pb-2 mb-3 mt-4">{% trans "Order Details" %}</h5>
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "Tracking Number" %}:</strong>
            </div>
            <div class="col-sm-8">
                {{ delivery.tracking_number }}
            </div>
        </div>
        
        {% if delivery.delivery_cost > 0 %}
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "COD Amount" %}:</strong>
            </div>
            <div class="col-sm-8">
                <span class="fw-medium">{{ delivery.delivery_cost }} AED</span>
            </div>
        </div>
        {% endif %}
        
        {% if delivery.delivery_notes %}
        <div class="row mb-3">
            <div class="col-sm-4">
                <strong>{% trans "Special Instructions" %}:</strong>
            </div>
            <div class="col-sm-8">
                {{ delivery.delivery_notes }}
            </div>
        </div>
        {% endif %}
        
        {% if delivery_attempts %}
        <h5 class="border-bottom pb-2 mb-3 mt-4">{% trans "Delivery Attempts" %}</h5>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{% trans "Attempt #" %}</th>
                        <th>{% trans "Date" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Notes" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in delivery_attempts %}
                    <tr>
                        <td>{{ attempt.attempt_number }}</td>
                        <td>{{ attempt.attempt_time|date:"M d, H:i" }}</td>
                        <td>
                            <span class="badge {% if attempt.status == 'successful' %}bg-success{% elif attempt.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ attempt.get_status_display }}
                            </span>
                        </td>
                        <td>{{ attempt.notes|truncatechars:50 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    
    <div class="action-buttons mt-4 d-flex flex-wrap gap-2">
        <a href="{% url 'delivery:panel_update_status' order_id=delivery.order.id %}" class="btn btn-primary flex-grow-1">
            <i class="bi bi-pencil"></i> {% trans "Update Status" %}
        </a>
        
        {% if delivery.status != 'delivered' and delivery.status != 'failed' %}
            <a href="{% url 'delivery:panel_complete_delivery' order_id=delivery.order.id %}" class="btn btn-success flex-grow-1">
                <i class="bi bi-check-circle"></i> {% trans "Mark Delivered" %}
            </a>
            
            <a href="{% url 'delivery:panel_failed_delivery' order_id=delivery.order.id %}" class="btn btn-danger flex-grow-1">
                <i class="bi bi-x-circle"></i> {% trans "Report Failed" %}
            </a>
        {% endif %}
    </div>
</div>

{% if status_history %}
<div class="panel-card mt-3">
    <div class="panel-card-header">
        <h2 class="panel-card-title">{% trans "Status History" %}</h2>
    </div>
    
    <div class="status-timeline">
        {% for status in status_history %}
        <div class="status-item">
            <div class="status-time">
                {{ status.created_at|date:"M d, H:i" }}
            </div>
            <div class="status-content">
                <div class="status-badge status-{{ status.status|lower }}">
                    {{ status.status }}
                </div>
                {% if status.notes %}
                <div class="status-notes mt-1">
                    {{ status.notes }}
                </div>
                {% endif %}
                {% if status.location %}
                <div class="status-location text-muted mt-1">
                    <small><i class="bi bi-geo-alt"></i> {{ status.location }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- SMS Modal -->
<div class="modal fade" id="smsModal" tabindex="-1" aria-labelledby="smsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="smsModalLabel">{% trans "Send SMS to Customer" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{% trans "Message Template" %}:</label>
                    <select class="form-select" id="smsTemplate">
                        <option value="">{% trans "Custom Message" %}</option>
                        <option value="on_way">{% trans "On the way" %}</option>
                        <option value="arrived">{% trans "Arrived at location" %}</option>
                        <option value="reschedule">{% trans "Need to reschedule" %}</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="smsMessage" class="form-label">{% trans "Message" %}:</label>
                    <textarea class="form-control" id="smsMessage" rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="sendSmsBtn">{% trans "Send SMS" %}</button>
            </div>
        </div>
    </div>
</div>

<style>
.order-timeline {
    padding: 20px 0;
}
.timeline-point {
    text-align: center;
    position: relative;
    width: 70px;
}
.timeline-point:not(:last-child):after {
    content: '';
    position: absolute;
    top: 15px;
    right: -15px;
    width: 30px;
    height: 2px;
    background-color: #e5e7eb;
}
.timeline-point.active:not(:last-child):after {
    background-color: var(--primary-color);
}
.timeline-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    color: #9ca3af;
}
.timeline-point.active .timeline-icon {
    background-color: var(--primary-color);
    color: white;
}
.timeline-label {
    font-size: 0.75rem;
    color: #6b7280;
}
.timeline-point.active .timeline-label {
    color: var(--primary-color);
    font-weight: 500;
}
.timeline-time {
    font-size: 0.7rem;
    color: #9ca3af;
    margin-top: 4px;
}

.status-timeline {
    padding: 10px 0;
}
.status-item {
    display: flex;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f3f4f6;
}
.status-item:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}
.status-time {
    min-width: 90px;
    color: #6b7280;
    font-size: 0.875rem;
}
.status-content {
    flex: 1;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const smsTemplate = document.getElementById('smsTemplate');
        const smsMessage = document.getElementById('smsMessage');
        const sendSmsBtn = document.getElementById('sendSmsBtn');
        
        // Templates
        const templates = {
            on_way: "Hello! I'm on my way to deliver your order {{ delivery.order.order_code }}. I'll arrive in approximately 15-30 minutes.",
            arrived: "Hello! I've arrived at your location to deliver order {{ delivery.order.order_code }}. Please come to the door or reception.",
            reschedule: "Hello! We couldn't complete delivery of order {{ delivery.order.order_code }} today. We'll attempt delivery tomorrow."
        };
        
        // Set message based on template
        if (smsTemplate) {
            smsTemplate.addEventListener('change', function() {
                const template = this.value;
                if (template && templates[template]) {
                    smsMessage.value = templates[template];
                } else {
                    smsMessage.value = '';
                }
            });
        }
        
        // Send SMS
        if (sendSmsBtn) {
            sendSmsBtn.addEventListener('click', function() {
                const message = smsMessage.value;
                const template = smsTemplate.value;
                
                if (!message) {
                    alert("{% trans 'Please enter a message' %}");
                    return;
                }
                
                // Make API call
                fetch('{% url "delivery:api_send_sms" order_id=delivery.order.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        message: message,
                        template: template
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("{% trans 'SMS sent successfully!' %}");
                        $('#smsModal').modal('hide');
                    } else {
                        alert("{% trans 'Error: ' %}" + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("{% trans 'An error occurred while sending the SMS' %}");
                });
            });
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %} 