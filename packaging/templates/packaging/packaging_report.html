{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Packaging Report" %}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block header %}{% trans "Packaging Performance Report" %}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="mb-4">
        <a href="{% url 'packaging:dashboard' %}" class="text-sm px-3 py-1 border border-gray-300 rounded hover:bg-gray-50 inline-flex items-center">
            <i class="fas fa-arrow-left mr-1"></i> {% trans "Back to Dashboard" %}
        </a>
    </div>
    
    <!-- Date Filter -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800">{% trans "Report Period" %}</h3>
            <div class="flex space-x-2">
                <a href="?date_filter=today" class="px-3 py-1 rounded text-sm {% if date_filter == 'today' %}bg-primary-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    {% trans "Today" %}
                </a>
                <a href="?date_filter=week" class="px-3 py-1 rounded text-sm {% if date_filter == 'week' %}bg-primary-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    {% trans "Last 7 Days" %}
                </a>
                <a href="?date_filter=month" class="px-3 py-1 rounded text-sm {% if date_filter == 'month' %}bg-primary-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    {% trans "Last 30 Days" %}
                </a>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <div class="rounded-full bg-green-100 p-3 mr-4">
                    <i class="fas fa-box text-green-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">{{ total_completed }}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Packages Completed" %}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <div class="rounded-full bg-blue-100 p-3 mr-4">
                    <i class="fas fa-clock text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">{{ avg_duration }} min</h3>
                    <p class="text-gray-500 text-sm">{% trans "Avg Duration" %}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <div class="rounded-full bg-yellow-100 p-3 mr-4">
                    <i class="fas fa-clipboard-check text-yellow-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">{{ total_checks }}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Quality Checks" %}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="flex items-center">
                <div class="rounded-full bg-purple-100 p-3 mr-4">
                    <i class="fas fa-percentage text-purple-600 text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">{{ pass_rate }}%</h3>
                    <p class="text-gray-500 text-sm">{% trans "Pass Rate" %}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Quality Check Breakdown -->
        <div class="bg-white rounded-lg shadow-md p-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Quality Check Results" %}</h3>
            
            <!-- Visual Chart -->
            <div class="h-48 mb-6">
                <canvas id="qualityCheckChart"></canvas>
            </div>
            
            <div class="space-y-3 mt-4">
                <div class="flex justify-between items-center p-3 bg-green-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        <span class="text-gray-700">{% trans "Passed" %}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-green-600">{{ passed_checks }}</span>
                        {% if total_checks > 0 %}
                        <span class="text-xs text-gray-500">({% widthratio passed_checks total_checks 100 %}%)</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                        <span class="text-gray-700">{% trans "Conditional" %}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-yellow-600">{{ conditional_checks }}</span>
                        {% if total_checks > 0 %}
                        <span class="text-xs text-gray-500">({% widthratio conditional_checks total_checks 100 %}%)</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="flex justify-between items-center p-3 bg-red-50 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-600 mr-2"></i>
                        <span class="text-gray-700">{% trans "Failed" %}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-red-600">{{ failed_checks }}</span>
                        {% if total_checks > 0 %}
                        <span class="text-xs text-gray-500">({% widthratio failed_checks total_checks 100 %}%)</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if total_checks == 0 %}
                <div class="text-center py-4 text-gray-500">
                    {% trans "No quality check data available" %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Daily Activity Chart -->
        <div class="bg-white rounded-lg shadow-md p-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Daily Activity" %}</h3>
            
            <!-- Visual Chart -->
            <div class="h-64 mb-6">
                <canvas id="dailyActivityChart"></canvas>
            </div>
            
            <!-- Daily Activity List -->
            <div class="space-y-3 mt-4 border-t pt-4">
                <div class="grid grid-cols-4 gap-4 text-xs font-medium text-gray-500 uppercase mb-2">
                    <div>{% trans "Date" %}</div>
                    <div class="text-center">{% trans "Packages" %}</div>
                    <div class="text-center">{% trans "Checks" %}</div>
                    <div class="text-center">{% trans "Avg Time" %}</div>
                </div>
                
                {% for stat in daily_stats %}
                <div class="grid grid-cols-4 gap-4 items-center py-2 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                    <div class="text-sm text-gray-700 font-medium">{{ stat.date|date:"M j" }}</div>
                    <div class="text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ stat.completed }}
                        </span>
                    </div>
                    <div class="text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            {{ stat.checks }}
                        </span>
                    </div>
                    <div class="text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            {{ stat.avg_duration }} min
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-gray-500">
                    {% trans "No daily activity data available" %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Packager Performance -->
    {% if packager_stats %}
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Packager Performance" %}</h3>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Packager" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Packages Completed" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Avg Duration" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Total Time" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Quality Checks" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "QC Pass Rate" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Performance" %}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for stat in packager_stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ stat.packager.get_full_name }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ stat.packages_completed }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ stat.avg_duration|floatformat:1 }} min
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ stat.total_time|floatformat:0 }} min
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ stat.quality_checks }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ stat.quality_pass_rate }}%
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            {% if stat.avg_duration <= 15 %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    {% trans "Excellent" %}
                                </span>
                            {% elif stat.avg_duration <= 25 %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                    {% trans "Good" %}
                                </span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                    {% trans "Needs Improvement" %}
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Package Type Distribution -->
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Package Type Distribution" %}</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for type, count in package_types.items %}
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">{{ type }}</span>
                    <span class="font-semibold text-gray-900">{{ count }}</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: {% widthratio count total_completed 100 %}%"></div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-4 text-center py-4 text-gray-500">
                {% trans "No package type data available" %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Material Usage -->
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-800">{% trans "Material Usage" %}</h3>
            <span class="text-sm text-gray-600">{% trans "Total Cost:" %} ${{ total_material_cost }}</span>
        </div>
        
        {% if material_stats %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Material" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Quantity" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Unit" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Cost" %}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for material in material_stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ material.name }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ material.quantity }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            {{ material.unit }}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            ${{ material.cost|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-6">
            <i class="fas fa-box-open text-gray-400 text-3xl mb-2"></i>
            <p class="text-gray-500">{% trans "No material usage data available" %}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Weight Statistics -->
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Package Weight Statistics" %}</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <div class="text-center">
                    <span class="text-sm text-gray-500">{% trans "Average Weight" %}</span>
                    <div class="text-xl font-bold text-blue-600 mt-1">{{ avg_weight }} kg</div>
                </div>
            </div>
            
            <div class="bg-green-50 p-4 rounded-lg">
                <div class="text-center">
                    <span class="text-sm text-gray-500">{% trans "Minimum Weight" %}</span>
                    <div class="text-xl font-bold text-green-600 mt-1">{{ min_weight }} kg</div>
                </div>
            </div>
            
            <div class="bg-purple-50 p-4 rounded-lg">
                <div class="text-center">
                    <span class="text-sm text-gray-500">{% trans "Maximum Weight" %}</span>
                    <div class="text-xl font-bold text-purple-600 mt-1">{{ max_weight }} kg</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quality Check Types -->
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">{% trans "Quality Check Types" %}</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for type, count in check_types.items %}
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">{{ type }}</span>
                    <span class="font-semibold text-gray-900">{{ count }}</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-yellow-500 h-2 rounded-full" style="width: {% widthratio count total_checks 100 %}%"></div>
                </div>
            </div>
            {% empty %}
            <div class="col-span-3 text-center py-4 text-gray-500">
                {% trans "No quality check type data available" %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Export Options -->
    <div class="bg-white rounded-lg shadow-md p-5 mt-6">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-800">{% trans "Export Report" %}</h3>
                <p class="text-sm text-gray-500 mt-1">{% trans "Export packaging data for the selected period" %}</p>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'packaging:export_report' %}?format=pdf&date_filter={{ date_filter }}" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors inline-flex items-center">
                    <i class="fas fa-file-pdf mr-2"></i> {% trans "Export PDF" %}
                </a>
                <a href="{% url 'packaging:export_report' %}?format=csv&date_filter={{ date_filter }}" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors inline-flex items-center">
                    <i class="fas fa-file-csv mr-2"></i> {% trans "Export CSV" %}
                </a>
            </div>
        </div>
        
        <div class="mt-4 border-t pt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">{% trans "Export Options" %}</h4>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'packaging:export_materials' %}" class="inline-flex items-center px-3 py-1 rounded text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i class="fas fa-box mr-1"></i> {% trans "Materials Inventory" %}
                </a>
                <a href="{% url 'packaging:export_packager_performance' %}" class="inline-flex items-center px-3 py-1 rounded text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i class="fas fa-user-clock mr-1"></i> {% trans "Packager Performance" %}
                </a>
                <a href="{% url 'packaging:export_quality_checks' %}" class="inline-flex items-center px-3 py-1 rounded text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i class="fas fa-clipboard-check mr-1"></i> {% trans "Quality Checks" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Quality Check Chart
        const qualityCheckCtx = document.getElementById('qualityCheckChart').getContext('2d');
        const qualityCheckChart = new Chart(qualityCheckCtx, {
            type: 'doughnut',
            data: {
                labels: ['{% trans "Passed" %}', '{% trans "Conditional" %}', '{% trans "Failed" %}'],
                datasets: [{
                    data: [{{ passed_checks }}, {{ conditional_checks }}, {{ failed_checks }}],
                    backgroundColor: [
                        'rgba(72, 187, 120, 0.7)',  // green
                        'rgba(237, 137, 54, 0.7)',  // yellow/orange
                        'rgba(229, 62, 62, 0.7)'    // red
                    ],
                    borderColor: [
                        'rgb(72, 187, 120)',
                        'rgb(237, 137, 54)',
                        'rgb(229, 62, 62)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // Daily Activity Chart
        const dailyActivityCtx = document.getElementById('dailyActivityChart').getContext('2d');
        const dailyActivityChart = new Chart(dailyActivityCtx, {
            type: 'bar',
            data: {
                labels: [{% for stat in daily_stats %}'{{ stat.date|date:"M j" }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [
                    {
                        label: '{% trans "Packages" %}',
                        data: [{% for stat in daily_stats %}{{ stat.completed }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(66, 153, 225, 0.7)',
                        borderColor: 'rgb(66, 153, 225)',
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "Quality Checks" %}',
                        data: [{% for stat in daily_stats %}{{ stat.checks }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        backgroundColor: 'rgba(72, 187, 120, 0.7)',
                        borderColor: 'rgb(72, 187, 120)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{% trans "Count" %}'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '{% trans "Date" %}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endblock %} 