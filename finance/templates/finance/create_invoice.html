{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Create Invoice" %}{% endblock %}

{% block header %}{% trans "Create Invoice" %}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <h2 class="text-2xl font-semibold text-gray-800">{% trans "Generate Invoice" %}</h2>
        <div class="flex space-x-3">
            <a href="{% url 'finance:dashboard' %}" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>{% trans "Back to Dashboard" %}
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Order Selection -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">{% trans "Select Order for Invoice" %}</h3>
                    <p class="text-sm text-gray-600">{% trans "Choose an order to generate an invoice" %}</p>
                </div>
                
                <div class="p-5">
                    <form method="post" action="{% url 'finance:create_invoice' %}" id="invoiceForm">
                        {% csrf_token %}
                        
                        <!-- Order Search -->
                        <div class="mb-6">
                            <label for="order_search" class="block text-sm font-medium text-gray-700 mb-2">{% trans "Search Orders" %}</label>
                            <div class="relative">
                                <input type="text" id="order_search" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500" placeholder="{% trans 'Search by order code or customer name' %}">
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Orders Table -->
                        <div class="overflow-x-auto border border-gray-200 rounded-md">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Select" %}
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Order Code" %}
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Customer" %}
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Date" %}
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Total" %}
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {% trans "Status" %}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% if orders %}
                                        {% for order in orders %}
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <input type="radio" name="order_id" value="{{ order.id }}" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    {{ order.code }}
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                    {{ order.customer.full_name }}
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                    {{ order.date|date:"d M Y" }}
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                                    {{ order.get_total_price }}
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                        {{ order.status }}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="px-4 py-6 text-center text-gray-500">
                                                {% trans "No orders found" %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Invoice Settings -->
        <div>
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-5 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">{% trans "Invoice Options" %}</h3>
                </div>
                
                <div class="p-5 space-y-4">
                    <!-- Invoice Date -->
                    <div>
                        <label for="invoice_date" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Invoice Date" %}</label>
                        <input type="date" id="invoice_date" name="invoice_date" form="invoiceForm" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500" value="{{ today|date:'Y-m-d' }}">
                    </div>
                    
                    <!-- Due Date -->
                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Due Date" %}</label>
                        <input type="date" id="due_date" name="due_date" form="invoiceForm" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    
                    <!-- Payment Terms -->
                    <div>
                        <label for="payment_terms" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Payment Terms" %}</label>
                        <select id="payment_terms" name="payment_terms" form="invoiceForm" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="due_on_receipt">{% trans "Due on Receipt" %}</option>
                            <option value="net_15">{% trans "Net 15" %}</option>
                            <option value="net_30">{% trans "Net 30" %}</option>
                            <option value="net_60">{% trans "Net 60" %}</option>
                        </select>
                    </div>
                    
                    <!-- Include Fees -->
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include_fees" name="include_fees" form="invoiceForm" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded" checked>
                            <label for="include_fees" class="ml-2 block text-sm text-gray-700">
                                {% trans "Include Fees" %}
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Invoice Notes" %}</label>
                        <textarea id="notes" name="notes" form="invoiceForm" rows="4" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500" placeholder="{% trans 'Add any notes to appear on the invoice' %}"></textarea>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="pt-4">
                        <button type="submit" form="invoiceForm" class="w-full px-6 py-3 bg-primary-500 text-white rounded hover:bg-primary-600 transition-colors">
                            <i class="fas fa-file-invoice mr-2"></i>{% trans "Generate Invoice" %}
                        </button>
                    </div>
                    
                    <!-- Preview Button -->
                    <div>
                        <button type="button" id="previewInvoice" class="w-full px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                            <i class="fas fa-eye mr-2"></i>{% trans "Preview Invoice" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-5xl mx-4 overflow-hidden">
            <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800">{% trans "Invoice Preview" %}</h3>
                <button type="button" id="closePreviewModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto" id="invoicePreviewContent">
                <!-- Invoice preview content will be loaded here -->
                <div class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                </div>
            </div>
            <div class="p-4 bg-gray-100 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" id="closePreviewButton" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
                    {% trans "Close" %}
                </button>
                <button type="submit" form="invoiceForm" class="px-4 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 transition-colors">
                    {% trans "Generate & Save" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('order_search');
        const tableRows = document.querySelectorAll('tbody tr');
        
        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            
            tableRows.forEach(row => {
                const orderCode = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const customerName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (orderCode.includes(searchTerm) || customerName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Set due date based on payment terms
        const paymentTerms = document.getElementById('payment_terms');
        const dueDateInput = document.getElementById('due_date');
        const invoiceDateInput = document.getElementById('invoice_date');
        
        function updateDueDate() {
            const invoiceDate = new Date(invoiceDateInput.value);
            let daysToAdd = 0;
            
            switch(paymentTerms.value) {
                case 'due_on_receipt':
                    daysToAdd = 0;
                    break;
                case 'net_15':
                    daysToAdd = 15;
                    break;
                case 'net_30':
                    daysToAdd = 30;
                    break;
                case 'net_60':
                    daysToAdd = 60;
                    break;
            }
            
            invoiceDate.setDate(invoiceDate.getDate() + daysToAdd);
            
            const month = String(invoiceDate.getMonth() + 1).padStart(2, '0');
            const day = String(invoiceDate.getDate()).padStart(2, '0');
            const year = invoiceDate.getFullYear();
            
            dueDateInput.value = `${year}-${month}-${day}`;
        }
        
        // Set today's date as default invoice date
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        
        invoiceDateInput.value = `${year}-${month}-${day}`;
        
        // Update due date on load
        updateDueDate();
        
        // Update due date when payment terms change
        paymentTerms.addEventListener('change', updateDueDate);
        
        // Update due date when invoice date changes
        invoiceDateInput.addEventListener('change', updateDueDate);
        
        // Invoice preview modal
        const previewButton = document.getElementById('previewInvoice');
        const modal = document.getElementById('invoicePreviewModal');
        const closeButton = document.getElementById('closePreviewModal');
        const closePreviewButton = document.getElementById('closePreviewButton');
        const previewContent = document.getElementById('invoicePreviewContent');
        
        previewButton.addEventListener('click', function() {
            // Show modal
            modal.classList.remove('hidden');
            
            // Get selected order ID
            const selectedOrderInput = document.querySelector('input[name="order_id"]:checked');
            
            if (!selectedOrderInput) {
                previewContent.innerHTML = '<div class="text-red-500 text-center">{% trans "Please select an order first" %}</div>';
                return;
            }
            
            const orderId = selectedOrderInput.value;
            
            // Load preview content via AJAX
            fetch(`/finance/api/invoice/${orderId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        previewContent.innerHTML = data.invoice_html;
                    } else {
                        previewContent.innerHTML = `<div class="text-red-500 text-center">${data.error}</div>`;
                    }
                })
                .catch(error => {
                    previewContent.innerHTML = `<div class="text-red-500 text-center">{% trans "Error loading preview" %}</div>`;
                    console.error('Error:', error);
                });
        });
        
        // Close modal
        function closeModal() {
            modal.classList.add('hidden');
        }
        
        closeButton.addEventListener('click', closeModal);
        closePreviewButton.addEventListener('click', closeModal);
        
        // Close modal when clicking outside
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    });
</script>
{% endblock %} 