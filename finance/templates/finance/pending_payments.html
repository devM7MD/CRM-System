{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Pending Payments" %}{% endblock %}

{% block header %}{% trans "Pending Payments" %}{% endblock %}

{% block content %}
<div class="container mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <h2 class="text-2xl font-semibold text-gray-800">{% trans "Pending Payments" %}</h2>
        <div class="flex space-x-3">
            <a href="{% url 'finance:dashboard' %}" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>{% trans "Back to Dashboard" %}
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-5 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-semibold text-gray-800">{% trans "Manage Pending Payments" %}</h3>
                <p class="text-sm text-gray-600">{% trans "Review and update payment statuses" %}</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-2">
                <button type="submit" form="pendingPaymentsForm" name="action" value="mark_paid" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>{% trans "Mark as Paid" %}
                </button>
                <button type="submit" form="pendingPaymentsForm" name="action" value="mark_postponed" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">
                    <i class="fas fa-clock mr-2"></i>{% trans "Postpone" %}
                </button>
            </div>
        </div>
        
        <div class="p-5">
            <!-- Payments Form -->
            <form id="pendingPaymentsForm" method="post" action="{% url 'finance:pending_payments' %}">
                {% csrf_token %}
                
                <!-- Payment Filters -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <div class="w-full md:w-auto">
                        <label for="seller_filter" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Filter by Seller" %}</label>
                        <select id="seller_filter" class="border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">{% trans "All Sellers" %}</option>
                            {% for payment in pending_payments %}
                                {% if payment.order.seller %}
                                    <option value="{{ payment.order.seller.id }}">{{ payment.order.seller.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="w-full md:w-auto">
                        <label for="date_filter" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Filter by Date" %}</label>
                        <select id="date_filter" class="border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                            <option value="">{% trans "All Dates" %}</option>
                            <option value="today">{% trans "Today" %}</option>
                            <option value="this_week">{% trans "This Week" %}</option>
                            <option value="this_month">{% trans "This Month" %}</option>
                            <option value="last_month">{% trans "Last Month" %}</option>
                        </select>
                    </div>
                    
                    <div class="w-full md:w-auto flex-grow">
                        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Search" %}</label>
                        <div class="relative">
                            <input type="text" id="search" class="w-full border border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:ring-primary-500 focus:border-primary-500" placeholder="{% trans 'Search by order ID, customer, etc.' %}">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payments Table -->
                <div class="overflow-x-auto border border-gray-200 rounded-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                    <input type="checkbox" id="select-all" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Order ID" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Customer" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Seller" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Amount" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Date" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Payment Method" %}
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    {% trans "Actions" %}
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% if pending_payments %}
                                {% for payment in pending_payments %}
                                    <tr class="hover:bg-gray-50 payment-row" data-seller-id="{{ payment.order.seller.id|default:'' }}" data-date="{{ payment.payment_date|date:'Y-m-d' }}">
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <input type="checkbox" name="payment_ids" value="{{ payment.id }}" class="payment-checkbox h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                            {{ payment.order.code }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                            {% if payment.order.customer %}
                                                {{ payment.order.customer.full_name }}
                                            {% else %}
                                                {% trans "Unknown Customer" %}
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                            {% if payment.order.seller %}
                                                {{ payment.order.seller.name }}
                                            {% else %}
                                                {% trans "Direct Sale" %}
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-primary-600">
                                            {{ payment.amount }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                            {{ payment.payment_date|date:"d M Y" }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                            {{ payment.get_payment_method_display }}
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                                            <div class="flex space-x-2">
                                                <a href="#" class="text-primary-600 hover:text-primary-900" title="{% trans 'View Details' %}">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="#" class="text-green-600 hover:text-green-900 mark-paid-btn" data-payment-id="{{ payment.id }}" title="{% trans 'Mark as Paid' %}">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                                <a href="#" class="text-yellow-600 hover:text-yellow-900 mark-postponed-btn" data-payment-id="{{ payment.id }}" title="{% trans 'Postpone' %}">
                                                    <i class="fas fa-clock"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="px-4 py-6 text-center text-gray-500">
                                        {% trans "No pending payments found" %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Selected Count -->
                <div class="mt-4 text-sm text-gray-500">
                    <span id="selected-count">0</span> {% trans "items selected" %}
                </div>
            </form>
            
            <!-- Pagination -->
            {% if pending_payments.paginator.num_pages > 1 %}
                <div class="mt-6 flex items-center justify-between border-t border-gray-200 pt-4">
                    <div class="text-sm text-gray-500">
                        {% trans "Showing" %} <span class="font-medium">{{ pending_payments.start_index }}</span> {% trans "to" %} <span class="font-medium">{{ pending_payments.end_index }}</span> {% trans "of" %} <span class="font-medium">{{ pending_payments.paginator.count }}</span> {% trans "results" %}
                    </div>
                    <div class="flex space-x-1">
                        {% if pending_payments.has_previous %}
                            <a href="?page={{ pending_payments.previous_page_number }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                                {% trans "Previous" %}
                            </a>
                        {% else %}
                            <span class="px-3 py-1 border border-gray-200 rounded-md text-sm text-gray-400 bg-gray-50 cursor-not-allowed">
                                {% trans "Previous" %}
                            </span>
                        {% endif %}
                        
                        {% if pending_payments.has_next %}
                            <a href="?page={{ pending_payments.next_page_number }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-700 hover:bg-gray-50">
                                {% trans "Next" %}
                            </a>
                        {% else %}
                            <span class="px-3 py-1 border border-gray-200 rounded-md text-sm text-gray-400 bg-gray-50 cursor-not-allowed">
                                {% trans "Next" %}
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Select all checkbox functionality
        const selectAllCheckbox = document.getElementById('select-all');
        const paymentCheckboxes = document.querySelectorAll('.payment-checkbox');
        const selectedCountEl = document.getElementById('selected-count');
        
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            
            // Only select visible rows
            const visibleCheckboxes = Array.from(paymentCheckboxes).filter(checkbox => {
                return checkbox.closest('tr').style.display !== 'none';
            });
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            updateSelectedCount();
        });
        
        paymentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        function updateSelectedCount() {
            const checkedCount = document.querySelectorAll('.payment-checkbox:checked').length;
            selectedCountEl.textContent = checkedCount;
        }
        
        // Seller filter functionality
        const sellerFilter = document.getElementById('seller_filter');
        const dateFilter = document.getElementById('date_filter');
        const searchInput = document.getElementById('search');
        const paymentRows = document.querySelectorAll('.payment-row');
        
        function applyFilters() {
            const selectedSeller = sellerFilter.value;
            const selectedDate = dateFilter.value;
            const searchTerm = searchInput.value.toLowerCase();
            
            paymentRows.forEach(row => {
                const sellerId = row.getAttribute('data-seller-id');
                const dateStr = row.getAttribute('data-date');
                
                let showBySeller = true;
                let showByDate = true;
                let showBySearch = true;
                
                // Apply seller filter
                if (selectedSeller && sellerId !== selectedSeller) {
                    showBySeller = false;
                }
                
                // Apply date filter
                if (selectedDate) {
                    const rowDate = new Date(dateStr);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const thisWeekStart = new Date(today);
                    thisWeekStart.setDate(today.getDate() - today.getDay());
                    
                    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    
                    if (selectedDate === 'today' && rowDate.toDateString() !== today.toDateString()) {
                        showByDate = false;
                    } else if (selectedDate === 'this_week' && (rowDate < thisWeekStart || rowDate > today)) {
                        showByDate = false;
                    } else if (selectedDate === 'this_month' && (rowDate < thisMonthStart || rowDate > today)) {
                        showByDate = false;
                    } else if (selectedDate === 'last_month' && (rowDate < lastMonthStart || rowDate > lastMonthEnd)) {
                        showByDate = false;
                    }
                }
                
                // Apply search filter
                if (searchTerm) {
                    const rowText = row.textContent.toLowerCase();
                    if (!rowText.includes(searchTerm)) {
                        showBySearch = false;
                    }
                }
                
                // Show/hide row based on all filters
                if (showBySeller && showByDate && showBySearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update select all checkbox state
            updateSelectAllCheckbox();
        }
        
        function updateSelectAllCheckbox() {
            const visibleCheckboxes = Array.from(paymentCheckboxes).filter(checkbox => {
                return checkbox.closest('tr').style.display !== 'none';
            });
            
            const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(checkbox => checkbox.checked);
            
            selectAllCheckbox.checked = allChecked;
        }
        
        sellerFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        searchInput.addEventListener('input', applyFilters);
        
        // Single row action buttons
        const markPaidBtns = document.querySelectorAll('.mark-paid-btn');
        const markPostponedBtns = document.querySelectorAll('.mark-postponed-btn');
        
        markPaidBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const paymentId = this.getAttribute('data-payment-id');
                const checkbox = document.querySelector(`.payment-checkbox[value="${paymentId}"]`);
                
                checkbox.checked = true;
                updateSelectedCount();
                
                document.querySelector('[name="action"][value="mark_paid"]').click();
            });
        });
        
        markPostponedBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const paymentId = this.getAttribute('data-payment-id');
                const checkbox = document.querySelector(`.payment-checkbox[value="${paymentId}"]`);
                
                checkbox.checked = true;
                updateSelectedCount();
                
                document.querySelector('[name="action"][value="mark_postponed"]').click();
            });
        });
    });
</script>
{% endblock %} 