{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Order Management - All Orders" %}{% endblock %}

{% block content %}
<div class="w-full">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-list text-primary-600 mr-3"></i>
                    {% trans "Order Management - All Orders" %}
                </h1>
                <p class="text-gray-600 mt-1">{% trans "Manage and assign orders to call center agents" %}</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="openBulkAssignModal()" class="btn-primary">
                    <i class="fas fa-users mr-2"></i>
                    {% trans "Bulk Assign" %}
                </button>
                <button onclick="exportOrders()" class="btn-secondary">
                    <i class="fas fa-download mr-2"></i>
                    {% trans "Export" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-6">
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Status" %}</label>
                    <select id="status-filter" class="form-select w-full">
                        <option value="">{% trans "All Status" %}</option>
                        <option value="pending">{% trans "Pending" %}</option>
                        <option value="confirmed">{% trans "Confirmed" %}</option>
                        <option value="cancelled">{% trans "Cancelled" %}</option>
                        <option value="postponed">{% trans "Postponed" %}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Agent" %}</label>
                    <select id="agent-filter" class="form-select w-full">
                        <option value="">{% trans "All Agents" %}</option>
                        {% for agent in all_agents %}
                        <option value="{{ agent.id }}">{{ agent.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Date Range" %}</label>
                    <select id="date-filter" class="form-select w-full">
                        <option value="today">{% trans "Today" %}</option>
                        <option value="yesterday">{% trans "Yesterday" %}</option>
                        <option value="week">{% trans "This Week" %}</option>
                        <option value="month">{% trans "This Month" %}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Priority" %}</label>
                    <select id="priority-filter" class="form-select w-full">
                        <option value="">{% trans "All Priorities" %}</option>
                        <option value="low">{% trans "Low" %}</option>
                        <option value="medium">{% trans "Medium" %}</option>
                        <option value="high">{% trans "High" %}</option>
                        <option value="urgent">{% trans "Urgent" %}</option>
                    </select>
                </div>
            </div>
            <div class="flex space-x-4">
                <div class="flex-1">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="{% trans 'Search orders, customers, products...' %}" 
                               class="form-input w-full pl-10">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <button onclick="applyFilters()" class="btn-primary">
                    <i class="fas fa-filter mr-2"></i>
                    {% trans "Apply Filters" %}
                </button>
                <button onclick="clearFilters()" class="btn-secondary">
                    <i class="fas fa-times mr-2"></i>
                    {% trans "Clear" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="card">
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-gray-900">{{ total_orders }}</div>
                <div class="text-sm text-gray-600">{% trans "Total" %}</div>
            </div>
        </div>
        <div class="card">
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-blue-600">{{ assigned_orders }}</div>
                <div class="text-sm text-gray-600">{% trans "Assigned" %}</div>
            </div>
        </div>
        <div class="card">
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-red-600">{{ unassigned_orders }}</div>
                <div class="text-sm text-gray-600">{% trans "Unassigned" %}</div>
            </div>
        </div>
        <div class="card">
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-green-600">{{ confirmed_orders }}</div>
                <div class="text-sm text-gray-600">{% trans "Confirmed" %}</div>
            </div>
        </div>
        <div class="card">
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-orange-600">{{ pending_orders }}</div>
                <div class="text-sm text-gray-600">{% trans "Pending" %}</div>
            </div>
        </div>
    </div>

    <!-- Unassigned High Priority Orders -->
    {% if high_priority_unassigned %}
    <div class="card mb-6">
        <div class="card-header bg-red-50 border-red-200">
            <h3 class="text-lg font-semibold text-red-900">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                {% trans "Unassigned High Priority Orders" %} ({{ high_priority_unassigned|length }})
            </h3>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-red-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Order Code" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Customer" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Product" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Price" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Status" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-red-700 uppercase tracking-wider">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for order in high_priority_unassigned %}
                        <tr class="bg-red-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ order.order_code }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ order.customer }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ order.product.name_en|default:"N/A" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">AED {{ order.total_price_aed }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">

                                    <button onclick="addNote({{ order.id }})" class="text-blue-600 hover:text-blue-900">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Orders Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "All Orders" %}</h3>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Order" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Customer" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Product" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Price" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Status" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Agent" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for order in orders %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" class="order-checkbox" value="{{ order.id }}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ order.order_code }}</div>
                                <div class="text-sm text-gray-500">{{ order.date|date:"M d, H:i" }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ order.customer }}</div>
                                <div class="text-sm text-gray-500">{{ order.customer_phone|default:"N/A" }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ order.product.name_en|default:"N/A" }}</div>
                                <div class="text-sm text-gray-500">{{ order.product.code|default:"N/A" }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">AED {{ order.total_price_aed }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if order.status == 'confirmed' %}bg-green-100 text-green-800
                                    {% elif order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                    {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if order.assignments.first.agent %}
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-xs font-medium text-blue-600">{{ order.assignments.first.agent.get_full_name|first }}</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ order.assignments.first.agent.get_full_name }}</div>
                                        <div class="text-xs text-gray-500">{{ order.assignments.first.priority_level|title }}</div>
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-sm text-gray-500">{% trans "Unassigned" %}</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button onclick="assignOrder({{ order.id }})" class="text-blue-600 hover:text-blue-900">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                    <button onclick="addNote({{ order.id }})" class="text-green-600 hover:text-green-900">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                    <button onclick="viewOrder({{ order.id }})" class="text-purple-600 hover:text-purple-900">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                {% trans "No orders found" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if orders.has_other_pages %}
            <div class="mt-6 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    {% trans "Showing" %} {{ orders.start_index }} {% trans "to" %} {{ orders.end_index }} {% trans "of" %} {{ orders.paginator.count }} {% trans "results" %}
                </div>
                <div class="flex space-x-2">
                    {% if orders.has_previous %}
                    <a href="?page={{ orders.previous_page_number }}" class="btn-secondary">{% trans "Previous" %}</a>
                    {% endif %}
                    {% if orders.has_next %}
                    <a href="?page={{ orders.next_page_number }}" class="btn-secondary">{% trans "Next" %}</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Enhanced Assign Order Modal -->
<div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">{% trans "Assign Order to Agent" %}</h3>
                    <p class="text-sm text-gray-600 mt-1">{% trans "Select an agent and set assignment details" %}</p>
                </div>
                <button onclick="closeAssignModal()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6">
                <!-- Order Details Section -->
                <div id="order-details" class="mb-6 bg-gray-50 rounded-lg p-4">
                    <!-- Order details will be loaded here -->
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- Agent Selection -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">{% trans "Select Agent" %}</label>
                            <select id="agent-select" class="form-select w-full border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500">
                                <option value="">{% trans "Choose an agent..." %}</option>
                                {% for agent in available_agents %}
                                <option value="{{ agent.id }}" data-load="{{ agent.current_load }}" data-availability="{{ agent.availability }}" data-performance="{{ agent.performance_rate }}">
                                    {{ agent.get_full_name }} ({{ agent.current_load }} orders, {{ agent.availability }}, {{ agent.performance_rate }}% performance)
                                </option>
                                {% endfor %}
                            </select>
                            <div id="agent-info" class="mt-2 text-sm text-gray-600 hidden">
                                <!-- Agent info will be displayed here -->
                            </div>
                        </div>
                        
                        <!-- Priority Level -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">{% trans "Priority Level" %}</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="priority" value="low" class="form-radio text-blue-600">
                                    <span class="ml-3">
                                        <span class="block text-sm font-medium text-gray-900">{% trans "Low" %}</span>
                                        <span class="block text-xs text-gray-500">{% trans "Standard processing" %}</span>
                                    </span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="priority" value="medium" class="form-radio text-blue-600" checked>
                                    <span class="ml-3">
                                        <span class="block text-sm font-medium text-gray-900">{% trans "Medium" %}</span>
                                        <span class="block text-xs text-gray-500">{% trans "Normal priority" %}</span>
                                    </span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="priority" value="high" class="form-radio text-blue-600">
                                    <span class="ml-3">
                                        <span class="block text-sm font-medium text-gray-900">{% trans "High" %}</span>
                                        <span class="block text-xs text-gray-500">{% trans "Urgent attention" %}</span>
                                    </span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="priority" value="urgent" class="form-radio text-blue-600">
                                    <span class="ml-3">
                                        <span class="block text-sm font-medium text-gray-900">{% trans "Urgent" %}</span>
                                        <span class="block text-xs text-gray-500">{% trans "Immediate action" %}</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Manager Notes -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">{% trans "Manager Notes" %}</label>
                            <textarea id="manager-notes" rows="4" class="form-textarea w-full border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500" 
                                      placeholder="{% trans 'Add instructions or notes for the agent...' %}"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">{% trans "Character count:" %} <span id="notes-count">0</span></span>
                                <span class="text-xs text-gray-500">{% trans "Max 500 characters" %}</span>
                            </div>
                        </div>
                        
                        <!-- Expected Completion -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">{% trans "Expected Completion" %}</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">{% trans "Date" %}</label>
                                    <input type="date" id="completion-date" class="form-input w-full border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">{% trans "Time" %}</label>
                                    <input type="time" id="completion-time" class="form-input w-full border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assignment Reason -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">{% trans "Assignment Reason" %}</label>
                            <select id="assignment-reason" class="form-select w-full border-2 border-gray-200 focus:border-blue-500 focus:ring-blue-500">
                                <option value="">{% trans "Select a reason..." %}</option>
                                <option value="expertise">{% trans "Agent Expertise" %}</option>
                                <option value="availability">{% trans "Agent Availability" %}</option>
                                <option value="performance">{% trans "Performance Based" %}</option>
                                <option value="workload">{% trans "Workload Balance" %}</option>
                                <option value="customer_request">{% trans "Customer Request" %}</option>
                                <option value="escalation">{% trans "Escalation" %}</option>
                                <option value="other">{% trans "Other" %}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    {% trans "Assignment will be logged and tracked" %}
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeAssignModal()" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                        {% trans "Cancel" %}
                    </button>
                    <button onclick="confirmAssignOrder()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200 flex items-center">
                        <i class="fas fa-check mr-2"></i>
                        {% trans "Assign Order" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">{% trans "Add Note" %}</h3>
                    <p class="text-sm text-gray-600 mt-1">{% trans "Add a note for this order" %}</p>
                </div>
                <button onclick="closeNoteModal()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6">
                <div id="note-order-details" class="mb-6 bg-gray-50 rounded-lg p-4">
                    <!-- Order details for note will be loaded here -->
                </div>
                
                <div class="space-y-4">
                    <!-- Note Type -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Note Type" %}</label>
                        <select id="note-type" class="form-select w-full border-2 border-gray-200 focus:border-green-500 focus:ring-green-500">
                            <option value="instruction">{% trans "Instruction" %}</option>
                            <option value="reminder">{% trans "Reminder" %}</option>
                            <option value="priority">{% trans "Priority" %}</option>
                            <option value="escalation">{% trans "Escalation" %}</option>
                        </select>
                    </div>
                    
                    <!-- Note Text -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">{% trans "Note Text" %}</label>
                        <textarea id="note-text" rows="4" class="form-textarea w-full border-2 border-gray-200 focus:border-green-500 focus:ring-green-500" 
                                  placeholder="{% trans 'Enter your note here...' %}"></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500">{% trans "Character count:" %} <span id="note-text-count">0</span></span>
                            <span class="text-xs text-gray-500">{% trans "Max 1000 characters" %}</span>
                        </div>
                    </div>
                    
                    <!-- Urgent Flag -->
                    <div class="flex items-center">
                        <input type="checkbox" id="note-urgent" class="form-checkbox text-green-600">
                        <label for="note-urgent" class="ml-2 text-sm text-gray-700">{% trans "Mark as urgent" %}</label>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeNoteModal()" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                    {% trans "Cancel" %}
                </button>
                <button onclick="confirmAddNote()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    {% trans "Save Note" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentOrderId = null;
let currentNoteOrderId = null;

function applyFilters() {
    const status = document.getElementById('status-filter').value;
    const agent = document.getElementById('agent-filter').value;
    const date = document.getElementById('date-filter').value;
    const priority = document.getElementById('priority-filter').value;
    const search = document.getElementById('search-input').value;
    
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (agent) params.append('agent', agent);
    if (date) params.append('date', date);
    if (priority) params.append('priority', priority);
    if (search) params.append('search', search);
    
    window.location.href = '?' + params.toString();
}

function clearFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('agent-filter').value = '';
    document.getElementById('date-filter').value = '';
    document.getElementById('priority-filter').value = '';
    document.getElementById('search-input').value = '';
}

function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function assignOrder(orderId, agentId = null) {
    currentOrderId = orderId;
    
    // Load order details
    fetch(`/callcenter/api/orders/${orderId}/details/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('order-details').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">Order Information</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Order Code:</span>
                                <span class="font-medium">${data.order_code}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Customer:</span>
                                <span class="font-medium">${data.customer}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Product:</span>
                                <span class="font-medium">${data.product}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Price:</span>
                                <span class="font-medium">AED ${data.price}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-3">Current Status</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="font-medium">${data.status}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Date:</span>
                                <span class="font-medium">${data.date}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Phone:</span>
                                <span class="font-medium">${data.phone || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (agentId) {
                document.getElementById('agent-select').value = agentId;
            }
            
            document.getElementById('assign-modal').classList.remove('hidden');
        });
}

function closeAssignModal() {
    document.getElementById('assign-modal').classList.add('hidden');
    currentOrderId = null;
    // Reset form
    document.getElementById('agent-select').value = '';
    document.getElementById('manager-notes').value = '';
    document.getElementById('completion-date').value = '';
    document.getElementById('completion-time').value = '';
    document.getElementById('assignment-reason').value = '';
    document.querySelector('input[name="priority"][value="medium"]').checked = true;
}

function confirmAssignOrder() {
    const agentId = document.getElementById('agent-select').value;
    const priority = document.querySelector('input[name="priority"]:checked').value;
    const notes = document.getElementById('manager-notes').value;
    const completionDate = document.getElementById('completion-date').value;
    const completionTime = document.getElementById('completion-time').value;
    const reason = document.getElementById('assignment-reason').value;
    
    if (!agentId) {
        showToast('Please select an agent', 'error');
        return;
    }
    
    const data = {
        agent_id: agentId,
        priority_level: priority,
        manager_notes: notes,
        expected_completion: completionDate + ' ' + completionTime,
        assignment_reason: reason
    };
    
    fetch(`/callcenter/api/orders/${currentOrderId}/assign/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeAssignModal();
            showToast('Order assigned successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error assigning order: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Assignment error:', error);
        showToast('Error assigning order: ' + error.message, 'error');
    });
}

function addNote(orderId) {
    currentNoteOrderId = orderId;
    
    // Load order details for note
    fetch(`/callcenter/api/orders/${orderId}/details/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('note-order-details').innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-gray-900">${data.order_code}</h4>
                        <p class="text-sm text-gray-600">${data.customer} - ${data.product}</p>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${data.status}
                    </span>
                </div>
            `;
            
            document.getElementById('note-modal').classList.remove('hidden');
        });
}

function closeNoteModal() {
    document.getElementById('note-modal').classList.add('hidden');
    currentNoteOrderId = null;
    // Reset form
    document.getElementById('note-type').value = 'instruction';
    document.getElementById('note-text').value = '';
    document.getElementById('note-urgent').checked = false;
}

function confirmAddNote() {
    const noteType = document.getElementById('note-type').value;
    const noteText = document.getElementById('note-text').value;
    const isUrgent = document.getElementById('note-urgent').checked;
    
    if (!noteText.trim()) {
        showToast('Please enter note text', 'error');
        return;
    }
    
    const data = {
        note_type: noteType,
        note_text: noteText,
        is_urgent: isUrgent
    };
    
    fetch(`/callcenter/api/orders/${currentNoteOrderId}/add-note/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeNoteModal();
            showToast('Note added successfully!', 'success');
        } else {
            showToast('Error adding note: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Note error:', error);
        showToast('Error adding note: ' + error.message, 'error');
    });
}

function viewOrder(orderId) {
    window.open(`/callcenter/order/${orderId}/`, '_blank');
}

function openBulkAssignModal() {
    const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
    if (selectedOrders.length === 0) {
        showToast('Please select orders to assign', 'error');
        return;
    }
    showToast(`Bulk assign ${selectedOrders.length} orders - coming soon!`, 'info');
}

function exportOrders() {
    showToast('Export functionality coming soon!', 'info');
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full`;
    
    switch(type) {
        case 'success':
            toast.className += ' bg-green-500';
            break;
        case 'error':
            toast.className += ' bg-red-500';
            break;
        case 'warning':
            toast.className += ' bg-yellow-500';
            break;
        default:
            toast.className += ' bg-blue-500';
    }
    
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-triangle' : type === 'warning' ? 'fa-exclamation' : 'fa-info'} mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Character count for textareas
document.addEventListener('DOMContentLoaded', function() {
    const managerNotes = document.getElementById('manager-notes');
    const noteText = document.getElementById('note-text');
    const notesCount = document.getElementById('notes-count');
    const noteTextCount = document.getElementById('note-text-count');
    
    if (managerNotes) {
        managerNotes.addEventListener('input', function() {
            const count = this.value.length;
            notesCount.textContent = count;
            if (count > 450) {
                notesCount.classList.add('text-red-500');
            } else {
                notesCount.classList.remove('text-red-500');
            }
        });
    }
    
    if (noteText) {
        noteText.addEventListener('input', function() {
            const count = this.value.length;
            noteTextCount.textContent = count;
            if (count > 900) {
                noteTextCount.classList.add('text-red-500');
            } else {
                noteTextCount.classList.remove('text-red-500');
            }
        });
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 