{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Agent Performance Reports" %}{% endblock %}

{% block content %}
<div class="w-full">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                    <i class="fas fa-chart-line text-primary-600 mr-3"></i>
                    {% trans "Agent Performance Reports" %}
                </h1>
                <p class="text-gray-600 mt-1">{% trans "Comprehensive performance analytics and reporting" %}</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportReport()" class="btn-secondary">
                    <i class="fas fa-download mr-2"></i>
                    {% trans "Export Report" %}
                </button>
                <button onclick="emailReport()" class="btn-primary">
                    <i class="fas fa-envelope mr-2"></i>
                    {% trans "Email Report" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Report Controls -->
    <div class="card mb-6">
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Select Agent" %}</label>
                    <select id="agent-select" class="form-select w-full" onchange="loadAgentReport()">
                        <option value="">{% trans "Choose an agent..." %}</option>
                        {% for agent in agents %}
                        <option value="{{ agent.id }}">{{ agent.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Time Period" %}</label>
                    <div class="flex space-x-2">
                        <label class="flex items-center">
                            <input type="radio" name="period" value="daily" class="form-radio" checked>
                            <span class="ml-2 text-sm">{% trans "Daily" %}</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="period" value="weekly" class="form-radio">
                            <span class="ml-2 text-sm">{% trans "Weekly" %}</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="period" value="monthly" class="form-radio">
                            <span class="ml-2 text-sm">{% trans "Monthly" %}</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "Date Range" %}</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="start-date" class="form-input text-sm">
                        <input type="date" id="end-date" class="form-input text-sm">
                    </div>
                </div>
                <div class="flex items-end">
                    <button onclick="loadReport()" class="btn-primary w-full">
                        <i class="fas fa-sync-alt mr-2"></i>
                        {% trans "Load Report" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Agent Performance Report -->
    <div id="individual-report" class="mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">{% trans "Individual Agent Performance Report" %}</h3>
            </div>
            <div class="p-6">
                <div id="agent-report-content">
                    <div class="text-center py-12">
                        <i class="fas fa-user text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">{% trans "Select an agent to view their performance report" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Performance Comparison -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "Weekly Team Performance Comparison" %}</h3>
            <p class="text-sm text-gray-600 mt-1">{% trans "Week of" %}: {{ week_start|date:"M d" }} - {{ week_end|date:"M d, Y" }}</p>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Rank" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Agent Name" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Orders" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Confirmed" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Rate" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Avg Time" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Satisfaction" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for agent in team_performance %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if forloop.counter == 1 %}
                                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                                    {% elif forloop.counter == 2 %}
                                    <i class="fas fa-medal text-gray-400 mr-2"></i>
                                    {% elif forloop.counter == 3 %}
                                    <i class="fas fa-award text-orange-500 mr-2"></i>
                                    {% endif %}
                                    <span class="text-sm font-medium text-gray-900">{{ forloop.counter }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-sm font-medium text-blue-600">{{ agent.name|first }}</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ agent.name }}</div>
                                        <div class="text-sm text-gray-500">Agent #{{ agent.id|stringformat:"03d" }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ agent.orders_handled }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ agent.orders_confirmed }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if agent.confirmation_rate >= 85 %}bg-green-100 text-green-800
                                    {% elif agent.confirmation_rate >= 75 %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ agent.confirmation_rate }}%
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ agent.avg_response_time }} min</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="text-sm text-gray-900 mr-1">{{ agent.satisfaction }}/5</span>
                                    <div class="flex space-x-1">
                                        {% for i in "12345" %}
                                        <i class="fas fa-star {% if forloop.counter <= agent.satisfaction %}text-yellow-400{% else %}text-gray-300{% endif %} text-xs"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="viewAgentDetail({{ agent.id }})" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="sendFeedback({{ agent.id }})" class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                {% trans "No performance data available" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Team Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">{% trans "Team Performance Metrics" %}</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{% trans "Team Average Confirmation Rate" %}</span>
                        <span class="text-lg font-bold text-gray-900">{{ team_avg_confirmation_rate|default:"80.7" }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {{ team_avg_confirmation_rate|default:80.7 }}%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{% trans "Team Average Response Time" %}</span>
                        <span class="text-lg font-bold text-gray-900">{{ team_avg_response_time|default:"3.8" }} min</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 76%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{% trans "Team Customer Satisfaction" %}</span>
                        <span class="text-lg font-bold text-gray-900">{{ team_avg_satisfaction|default:"4.5" }}/5</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-600 h-2 rounded-full" style="width: 90%"></div>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{% trans "Total Orders Processed" %}</span>
                        <span class="text-lg font-bold text-gray-900">{{ total_orders_processed|default:"678" }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">{% trans "Team Efficiency Score" %}</span>
                        <span class="text-lg font-bold text-gray-900">{{ team_efficiency_score|default:"85.2" }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: {{ team_efficiency_score|default:85.2 }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">{% trans "Achievements & Improvements" %}</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <h4 class="font-medium text-green-900 mb-2">🏆 {% trans "Achievements This Week" %}</h4>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>{% trans "Sarah Al-Mansouri: Highest confirmation rate" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>{% trans "Omar Al-Rashid: Fastest average response time" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                <span>{% trans "Team exceeded weekly targets by 12%" %}</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-medium text-orange-900 mb-2">⚠️ {% trans "Areas for Improvement" %}</h4>
                        <ul class="space-y-2 text-sm">
                            <li class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-orange-600 mt-1 mr-2"></i>
                                <span>{% trans "Focus on reducing cancellation rates" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-orange-600 mt-1 mr-2"></i>
                                <span>{% trans "Improve first-call resolution metrics" %}</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-orange-600 mt-1 mr-2"></i>
                                <span>{% trans "Balance workload distribution" %}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Trends -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">{% trans "Confirmation Rate Trend" %}</h3>
            </div>
            <div class="p-6">
                <div class="h-64 flex items-end justify-between space-x-2">
                    <div class="flex-1 bg-green-100 rounded-t" style="height: 75%"></div>
                    <div class="flex-1 bg-green-200 rounded-t" style="height: 80%"></div>
                    <div class="flex-1 bg-green-300 rounded-t" style="height: 85%"></div>
                    <div class="flex-1 bg-green-400 rounded-t" style="height: 78%"></div>
                    <div class="flex-1 bg-green-500 rounded-t" style="height: 82%"></div>
                    <div class="flex-1 bg-green-600 rounded-t" style="height: 88%"></div>
                    <div class="flex-1 bg-green-700 rounded-t" style="height: 85%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm text-gray-600">
                    <span>{% trans "Mon" %}</span>
                    <span>{% trans "Tue" %}</span>
                    <span>{% trans "Wed" %}</span>
                    <span>{% trans "Thu" %}</span>
                    <span>{% trans "Fri" %}</span>
                    <span>{% trans "Sat" %}</span>
                    <span>{% trans "Sun" %}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">{% trans "Response Time Trend" %}</h3>
            </div>
            <div class="p-6">
                <div class="h-64 flex items-end justify-between space-x-2">
                    <div class="flex-1 bg-blue-100 rounded-t" style="height: 60%"></div>
                    <div class="flex-1 bg-blue-200 rounded-t" style="height: 55%"></div>
                    <div class="flex-1 bg-blue-300 rounded-t" style="height: 65%"></div>
                    <div class="flex-1 bg-blue-400 rounded-t" style="height: 50%"></div>
                    <div class="flex-1 bg-blue-500 rounded-t" style="height: 58%"></div>
                    <div class="flex-1 bg-blue-600 rounded-t" style="height: 52%"></div>
                    <div class="flex-1 bg-blue-700 rounded-t" style="height: 48%"></div>
                </div>
                <div class="flex justify-between mt-4 text-sm text-gray-600">
                    <span>{% trans "Mon" %}</span>
                    <span>{% trans "Tue" %}</span>
                    <span>{% trans "Wed" %}</span>
                    <span>{% trans "Thu" %}</span>
                    <span>{% trans "Fri" %}</span>
                    <span>{% trans "Sat" %}</span>
                    <span>{% trans "Sun" %}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center space-x-4">
        <button onclick="emailTeamReport()" class="btn-primary">
            <i class="fas fa-envelope mr-2"></i>
            {% trans "Email Team Report" %}
        </button>
        <button onclick="generateIndividualFeedback()" class="btn-secondary">
            <i class="fas fa-comments mr-2"></i>
            {% trans "Individual Feedback" %}
        </button>
        <button onclick="exportDetailedReport()" class="btn-secondary">
            <i class="fas fa-file-export mr-2"></i>
            {% trans "Export Detailed Report" %}
        </button>
    </div>
</div>

<script>
function loadAgentReport() {
    const agentId = document.getElementById('agent-select').value;
    if (!agentId) return;
    
    const period = document.querySelector('input[name="period"]:checked').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    // Load agent report via AJAX
    fetch(`/callcenter/agent/${agentId}/report/?period=${period}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            displayAgentReport(data);
        });
}

function displayAgentReport(data) {
    const content = document.getElementById('agent-report-content');
    content.innerHTML = `
        <div class="mb-6">
            <h4 class="text-xl font-bold text-gray-900 mb-2">${data.agent_name} - {% trans "Performance Report" %}</h4>
            <p class="text-gray-600">{% trans "Report Period" %}: ${data.period}</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-900">${data.orders_handled}</div>
                <div class="text-sm text-blue-700">{% trans "Orders Handled" %}</div>
                <div class="text-xs text-blue-600">{% trans "Target" %}: 20 ✅</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-900">${data.confirmation_rate}%</div>
                <div class="text-sm text-green-700">{% trans "Confirmation Rate" %}</div>
                <div class="text-xs text-green-600">{% trans "Target" %}: 85% ✅</div>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                <div class="text-2xl font-bold text-yellow-900">${data.avg_response_time} min</div>
                <div class="text-sm text-yellow-700">{% trans "Avg Response Time" %}</div>
                <div class="text-xs text-yellow-600">{% trans "Target" %}: <5 min ✅</div>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-lg">
                <div class="text-2xl font-bold text-purple-900">${data.satisfaction}/5</div>
                <div class="text-sm text-purple-700">{% trans "Customer Satisfaction" %}</div>
                <div class="text-xs text-purple-600">{% trans "Target" %}: >4.0 ✅</div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h5 class="font-medium text-gray-900 mb-3">{% trans "Performance Trend (Last 7 Days)" %}</h5>
                <div class="h-32 bg-gray-100 rounded flex items-end justify-between p-2">
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 60%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 75%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 85%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 70%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 90%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 80%"></div>
                    <div class="w-8 bg-blue-500 rounded-t" style="height: 95%"></div>
                </div>
            </div>
            <div>
                <h5 class="font-medium text-gray-900 mb-3">{% trans "Recent Customer Feedback" %}</h5>
                <div class="space-y-2">
                    <div class="text-sm">
                        <span class="text-gray-600">"Excellent service, very professional"</span>
                        <div class="flex items-center mt-1">
                            <div class="flex space-x-1">
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm">
                        <span class="text-gray-600">"Quick response and helpful"</span>
                        <div class="flex items-center mt-1">
                            <div class="flex space-x-1">
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                                <i class="fas fa-star text-yellow-400 text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function loadReport() {
    const agentId = document.getElementById('agent-select').value;
    if (agentId) {
        loadAgentReport();
    }
}

function viewAgentDetail(agentId) {
    document.getElementById('agent-select').value = agentId;
    loadAgentReport();
}

function sendFeedback(agentId) {
    // Implement send feedback functionality
    alert('Send feedback functionality coming soon!');
}

function exportReport() {
    // Implement export functionality
    alert('Export functionality coming soon!');
}

function emailReport() {
    // Implement email functionality
    alert('Email functionality coming soon!');
}

function emailTeamReport() {
    // Implement team report email
    alert('Team report email functionality coming soon!');
}

function generateIndividualFeedback() {
    // Implement individual feedback generation
    alert('Individual feedback generation coming soon!');
}

function exportDetailedReport() {
    // Implement detailed report export
    alert('Detailed report export coming soon!');
}

// Set default dates
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    document.getElementById('end-date').value = today.toISOString().split('T')[0];
    document.getElementById('start-date').value = weekAgo.toISOString().split('T')[0];
});
</script>
{% endblock %} 